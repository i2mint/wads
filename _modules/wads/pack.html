

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>wads.pack &mdash; wads 0.1.51 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=56cc1d78"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/toggleprompt.js?v=d7ede5d2"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            wads
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/wads.html">wads</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/wads/ci_migration.html">wads.ci_migration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/wads/config_comparison.html">wads.config_comparison</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/wads/generate_project_wheels.html">wads.generate_project_wheels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/wads/github_ci_ops.html">wads.github_ci_ops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/wads/licensing.html">wads.licensing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/wads/migration.html">wads.migration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/wads/migration_quick_ref.html">wads.migration_quick_ref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/wads/pack.html">wads.pack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/wads/package_module.html">wads.package_module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/wads/populate.html">wads.populate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/wads/scrap/handle_non_python_installs.html">wads.scrap.handle_non_python_installs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/wads/tests/data/example_module.html">wads.tests.data.example_module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/wads/tests/test_config_comparison.html">wads.tests.test_config_comparison</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/wads/tests/test_migration.html">wads.tests.test_migration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/wads/tests/test_populate_and_pack.html">wads.tests.test_populate_and_pack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/wads/toml_util.html">wads.toml_util</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/wads/trans.html">wads.trans</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_docs/wads/util.html">wads.util</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">wads</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">wads.pack</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for wads.pack</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Utils to package and publish.</span>



<span class="sd">The typical sequence of the methodic and paranoid could be something like this:</span>

<span class="sd">::</span>

<span class="sd">    python pack.py current-configs  # see what you got</span>
<span class="sd">    python pack.py increment-configs-version  # update (increment the version and write that in setup.cfg</span>
<span class="sd">    python pack.py current-configs-version  # see that it worked</span>
<span class="sd">    python pack.py current-configs  # ... if you really want to see the whole configs again (you&#39;re really paranoid)</span>
<span class="sd">    python pack.py run-setup  # see that it worked</span>
<span class="sd">    python pack.py twine-upload-dist  # publish</span>
<span class="sd">    # and then go check things work...</span>



<span class="sd">If you&#39;re crazy (or know what you&#39;re doing) just do</span>

<span class="sd">::</span>

<span class="sd">    python pack.py go</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">importlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wads.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">git</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wads.toml_util</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">read_pyproject_toml</span><span class="p">,</span>
    <span class="n">write_pyproject_toml</span><span class="p">,</span>
    <span class="n">get_project_version</span><span class="p">,</span>
    <span class="n">set_project_version</span><span class="p">,</span>
    <span class="n">get_project_name</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pkgutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">types</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModuleType</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pprint</span><span class="w"> </span><span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">warnings</span><span class="w"> </span><span class="kn">import</span> <span class="n">warn</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Literal</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">Sequence</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">configparser</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigParser</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">argh</span>

<span class="n">CONFIG_FILE_NAME</span> <span class="o">=</span> <span class="s2">&quot;setup.cfg&quot;</span>
<span class="n">PYPROJECT_FILE_NAME</span> <span class="o">=</span> <span class="s2">&quot;pyproject.toml&quot;</span>
<span class="n">METADATA_SECTION</span> <span class="o">=</span> <span class="s2">&quot;metadata&quot;</span>
<span class="n">OPTIONS_SECTION</span> <span class="o">=</span> <span class="s2">&quot;options&quot;</span>
<span class="n">DFLT_OPTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;packages&quot;</span><span class="p">:</span> <span class="s2">&quot;find:&quot;</span><span class="p">,</span>
    <span class="s2">&quot;include_package_data&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;zip_safe&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;extras_require_testing&quot;</span><span class="p">:</span> <span class="p">[],</span>
<span class="p">}</span>

<span class="n">pjoin</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">p</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="n">DOCSRC</span> <span class="o">=</span> <span class="s2">&quot;docsrc&quot;</span>
<span class="n">DFLT_PUBLISH_DOCS_TO</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># &#39;github&#39;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_has_pyproject_toml</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if package uses pyproject.toml&quot;&quot;&quot;</span>
    <span class="n">pkg_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pkg_dir</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">):</span>
        <span class="n">pkg_dir</span> <span class="o">=</span> <span class="n">pkg_dir</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pyproject_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">PYPROJECT_FILE_NAME</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pyproject_path</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_has_setup_cfg</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if package has setup.cfg&quot;&quot;&quot;</span>
    <span class="n">pkg_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pkg_dir</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">):</span>
        <span class="n">pkg_dir</span> <span class="o">=</span> <span class="n">pkg_dir</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">setup_cfg_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">CONFIG_FILE_NAME</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">setup_cfg_path</span><span class="p">)</span>


<div class="viewcode-block" id="get_name_from_configs">
<a class="viewcode-back" href="../../module_docs/wads/pack.html#wads.pack.get_name_from_configs">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_name_from_configs</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">assert_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get name from local config file (pyproject.toml or setup.cfg)&quot;&quot;&quot;</span>
    <span class="n">pkg_dir</span> <span class="o">=</span> <span class="n">_get_pkg_dir</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>

    <span class="c1"># Prefer pyproject.toml if it exists</span>
    <span class="k">if</span> <span class="n">_has_pyproject_toml</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">get_project_name</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">configs</span> <span class="o">=</span> <span class="n">read_configs</span><span class="p">(</span><span class="n">pkg_dir</span><span class="o">=</span><span class="n">pkg_dir</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">configs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">assert_exists</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;No name was found in configs&quot;</span>
    <span class="k">return</span> <span class="n">name</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">clog</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">log_func</span><span class="o">=</span><span class="n">pprint</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">condition</span><span class="p">:</span>
        <span class="n">log_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<div class="viewcode-block" id="check_in">
<a class="viewcode-back" href="../../module_docs/wads/pack.html#wads.pack.check_in">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_in</span><span class="p">(</span>
    <span class="n">commit_message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">work_tree</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
    <span class="n">git_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">auto_choose_default_action</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">bypass_docstring_validation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">bypass_tests</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">bypass_code_formatting</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">pre_git_hooks</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate, normalize, stage, commit and push your local changes to a remote repository.</span>

<span class="sd">    :param commit_message: Your commit message</span>
<span class="sd">    :type commit_message: str</span>
<span class="sd">    :param work_tree: The relative or absolute path of the working directory. Defaults to &#39;.&#39;.</span>
<span class="sd">    :type work_tree: str, optional</span>
<span class="sd">    :param git_dir: The relative or absolute path of the git directory. If None, it will be taken to be &quot;{work_tree}/.git/&quot;. Defaults to None.</span>
<span class="sd">    :type git_dir: str, optional</span>
<span class="sd">    :param auto_choose_default_action: Set to True if you don&#39;t want to be prompted and automatically select the default action. Defaults to False.</span>
<span class="sd">    :type auto_choose_default_action: bool, optional</span>
<span class="sd">    :param bypass_docstring_validation: Set to True if you don&#39;t want to check if a docstring exists for every module, class and function. Defaults to False.</span>
<span class="sd">    :type bypass_docstring_validation: bool, optional</span>
<span class="sd">    :param bypass_tests: Set to True if you don&#39;t want to run doctests and other tests. Defaults to False.</span>
<span class="sd">    :type bypass_tests: bool, optional</span>
<span class="sd">    :param bypass_code_formatting: Set to True if you don&#39;t want the code to be automatically formatted using axblack. Defaults to False.</span>
<span class="sd">    :type bypass_code_formatting: bool, optional</span>
<span class="sd">    :param verbose: Set to True if you want to log extra information during the process. Defaults to False.</span>
<span class="sd">    :type verbose: bool, optional</span>
<span class="sd">    :param pre_git_hooks: A sequence of git commands to run before the git commit. Defaults to ().</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ggit</span><span class="p">(</span><span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">git</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">work_tree</span><span class="o">=</span><span class="n">work_tree</span><span class="p">,</span> <span class="n">git_dir</span><span class="o">=</span><span class="n">git_dir</span><span class="p">)</span>
        <span class="n">clog</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">log_func</span><span class="o">=</span><span class="nb">print</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">print_step_title</span><span class="p">(</span><span class="n">step_title</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;============= </span><span class="si">{</span><span class="n">step_title</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> =============&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- </span><span class="si">{</span><span class="n">step_title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">abort</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Aborting&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">confirm</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">auto_choose_default_action</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>
        <span class="k">return</span> <span class="n">argh</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">confirm</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">verify_current_changes</span><span class="p">():</span>
        <span class="n">print_step_title</span><span class="p">(</span><span class="s2">&quot;Verify current changes&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;nothing to commit, working tree clean&quot;</span> <span class="ow">in</span> <span class="n">ggit</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No changes to check in.&quot;</span><span class="p">)</span>
            <span class="n">abort</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">pull_remote_changes</span><span class="p">():</span>
        <span class="n">print_step_title</span><span class="p">(</span><span class="s2">&quot;Pull remote changes&quot;</span><span class="p">)</span>
        <span class="n">ggit</span><span class="p">(</span><span class="s2">&quot;stash&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">ggit</span><span class="p">(</span><span class="s2">&quot;pull&quot;</span><span class="p">)</span>
        <span class="n">ggit</span><span class="p">(</span><span class="s2">&quot;stash apply&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="s2">&quot;Already up to date.&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">confirm</span><span class="p">(</span>
            <span class="s2">&quot;Your local repository was not up to date, but it is now. Do you want to continue&quot;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">abort</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_docstrings</span><span class="p">():</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">run_pylint</span><span class="p">(</span><span class="n">current_dir</span><span class="p">):</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">pylint.lint</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="s2">&quot;__init__.py&quot;</span><span class="p">)):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">pylint</span><span class="o">.</span><span class="n">lint</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">current_dir</span><span class="p">,</span>
                        <span class="s2">&quot;--disable=all&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;--enable=C0114,C0115,C0116&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="n">do_exit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">linter</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;global_note&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">confirm</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Docstrings are missing in directory </span><span class="si">{</span><span class="n">current_dir</span><span class="si">}</span><span class="s2">. Do you want to continue&quot;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="n">abort</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="nb">next</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">current_dir</span><span class="p">))[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">run_pylint</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="n">subdir</span><span class="p">))</span>

        <span class="n">print_step_title</span><span class="p">(</span><span class="s2">&quot;Validate docstrings&quot;</span><span class="p">)</span>
        <span class="n">run_pylint</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_tests</span><span class="p">():</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

        <span class="n">print_step_title</span><span class="p">(</span><span class="s2">&quot;Run tests&quot;</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;--doctest-modules&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-v&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="s2">&quot;--no-summary&quot;</span><span class="p">])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">pytest</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="n">pytest</span><span class="o">.</span><span class="n">ExitCode</span><span class="o">.</span><span class="n">TESTS_FAILED</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">confirm</span><span class="p">(</span>
            <span class="s2">&quot;Tests have failed. Do you want to push anyway&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">):</span>
            <span class="n">abort</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">result</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">pytest</span><span class="o">.</span><span class="n">ExitCode</span><span class="o">.</span><span class="n">OK</span><span class="p">,</span>
            <span class="n">pytest</span><span class="o">.</span><span class="n">ExitCode</span><span class="o">.</span><span class="n">NO_TESTS_COLLECTED</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something went wrong when running tests. Please check the output.&quot;</span><span class="p">)</span>
            <span class="n">abort</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">format_code</span><span class="p">():</span>
        <span class="n">print_step_title</span><span class="p">(</span><span class="s2">&quot;Format code&quot;</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="s2">&quot;black --line-length=88 .&quot;</span><span class="p">,</span>
            <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">capture_output</span><span class="o">=</span><span class="ow">not</span> <span class="n">verbose</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">commit_changes</span><span class="p">():</span>
        <span class="n">print_step_title</span><span class="p">(</span><span class="s2">&quot;Commit changes&quot;</span><span class="p">)</span>
        <span class="n">ggit</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;commit --all --message=&quot;</span><span class="si">{</span><span class="n">commit_message</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">push_changes</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">confirm</span><span class="p">(</span>
            <span class="s2">&quot;Your changes have been commited. Do you want to push&quot;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">abort</span><span class="p">()</span>
        <span class="n">print_step_title</span><span class="p">(</span><span class="s2">&quot;Push changes&quot;</span><span class="p">)</span>
        <span class="n">ggit</span><span class="p">(</span><span class="s2">&quot;push&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">pre_git_hook</span> <span class="ow">in</span> <span class="n">pre_git_hooks</span> <span class="ow">or</span> <span class="p">[]:</span>
            <span class="n">ggit</span><span class="p">(</span><span class="n">pre_git_hook</span><span class="p">)</span>
        <span class="n">verify_current_changes</span><span class="p">()</span>
        <span class="n">pull_remote_changes</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bypass_docstring_validation</span><span class="p">:</span>
            <span class="n">validate_docstrings</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bypass_tests</span><span class="p">:</span>
            <span class="n">run_tests</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bypass_code_formatting</span><span class="p">:</span>
            <span class="n">format_code</span><span class="p">()</span>
            <span class="n">verify_current_changes</span><span class="p">()</span>  <span class="c1"># check again after formatting</span>
        <span class="n">commit_changes</span><span class="p">()</span>
        <span class="n">push_changes</span><span class="p">()</span>

    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;An error occured. Please check the output.&quot;</span><span class="p">)</span>
        <span class="n">abort</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Your changes have been checked in successfully!&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="goo">
<a class="viewcode-back" href="../../module_docs/wads/pack.html#wads.pack.goo">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">goo</span><span class="p">(</span>
    <span class="n">pkg_dir</span><span class="p">,</span>
    <span class="n">commit_message</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">git_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">auto_choose_default_action</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">bypass_docstring_validation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">bypass_tests</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">bypass_code_formatting</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate, normalize, stage, commit and push your local changes to a remote repository.</span>

<span class="sd">    :param pkg_dir: The relative or absolute path of the working directory. Defaults to &#39;.&#39;.</span>
<span class="sd">    :type pkg_dir: str, optional</span>
<span class="sd">    :param commit_message: Your commit message</span>
<span class="sd">    :type commit_message: str</span>
<span class="sd">    :param git_dir: The relative or absolute path of the git directory. If None, it will be taken to be &quot;{work_tree}/.git/&quot;. Defaults to None.</span>
<span class="sd">    :type git_dir: str, optional</span>
<span class="sd">    :param auto_choose_default_action: Set to True if you don&#39;t want to be prompted and automatically select the default action. Defaults to False.</span>
<span class="sd">    :type auto_choose_default_action: bool, optional</span>
<span class="sd">    :param bypass_docstring_validation: Set to True if you don&#39;t want to check if a docstring exists for every module, class and function. Defaults to False.</span>
<span class="sd">    :type bypass_docstring_validation: bool, optional</span>
<span class="sd">    :param bypass_tests: Set to True if you don&#39;t want to run doctests and other tests. Defaults to False.</span>
<span class="sd">    :type bypass_tests: bool, optional</span>
<span class="sd">    :param bypass_code_formatting: Set to True if you don&#39;t want the code to be automatically formatted using axblack. Defaults to False.</span>
<span class="sd">    :type bypass_code_formatting: bool, optional</span>
<span class="sd">    :param verbose: Set to True if you want to log extra information during the process. Defaults to False.</span>
<span class="sd">    :type verbose: bool, optional</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">check_in</span><span class="p">(</span>
        <span class="n">commit_message</span><span class="o">=</span><span class="n">commit_message</span><span class="p">,</span>
        <span class="n">work_tree</span><span class="o">=</span><span class="n">pkg_dir</span><span class="p">,</span>
        <span class="n">git_dir</span><span class="o">=</span><span class="n">git_dir</span><span class="p">,</span>
        <span class="n">auto_choose_default_action</span><span class="o">=</span><span class="n">auto_choose_default_action</span><span class="p">,</span>
        <span class="n">bypass_docstring_validation</span><span class="o">=</span><span class="n">bypass_docstring_validation</span><span class="p">,</span>
        <span class="n">bypass_tests</span><span class="o">=</span><span class="n">bypass_tests</span><span class="p">,</span>
        <span class="n">bypass_code_formatting</span><span class="o">=</span><span class="n">bypass_code_formatting</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
    <span class="p">)</span></div>



<span class="c1"># TODO: Add a function that adds/commits/pushes the updated setup.cfg</span>
<span class="c1"># TODO: Include tests as first step</span>
<span class="c1"># TODO: blackify</span>
<span class="c1"># TODO: Git pull and make sure no conflicts before moving on...</span>
<div class="viewcode-block" id="go">
<a class="viewcode-back" href="../../module_docs/wads/pack.html#wads.pack.go">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">go</span><span class="p">(</span>
    <span class="n">pkg_dir</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">publish_docs_to</span><span class="o">=</span><span class="n">DFLT_PUBLISH_DOCS_TO</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">skip_git_commit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">answer_yes_to_all_prompts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">twine_upload_options_str</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">keep_dist_pkgs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">commit_message</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update version, package and deploy:</span>
<span class="sd">    Runs in a sequence: increment_configs_version, update_setup_cfg, run_setup, twine_upload_dist</span>

<span class="sd">    :param version: The desired version (if not given, will increment the current version</span>
<span class="sd">    :param verbose: Whether to print stuff or not</span>
<span class="sd">    :param skip_git_commit: Whether to skip the git commit and push step</span>
<span class="sd">    :param answer_yes_to_all_prompts: If you do git commit and push, whether to ask confirmation after showing status</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: Would like version to be decremented if the publication attempt fails!</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">increment_configs_version</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">)</span>
    <span class="n">update_setup_cfg</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">run_setup</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
    <span class="n">twine_upload_dist</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">options_str</span><span class="o">=</span><span class="n">twine_upload_options_str</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_dist_pkgs</span><span class="p">:</span>
        <span class="n">delete_pkg_directories</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">publish_docs_to</span><span class="p">:</span>
        <span class="n">generate_and_publish_docs</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">publish_docs_to</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_git_commit</span><span class="p">:</span>
        <span class="n">git_commit_and_push</span><span class="p">(</span>
            <span class="n">pkg_dir</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="n">answer_yes_to_all_prompts</span><span class="o">=</span><span class="n">answer_yes_to_all_prompts</span><span class="p">,</span>
            <span class="n">commit_message</span><span class="o">=</span><span class="n">commit_message</span><span class="p">,</span>
        <span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">git_commit_and_push</span><span class="p">(</span>
    <span class="n">pkg_dir</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">answer_yes_to_all_prompts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">commit_message</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">what_to_add</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ggit</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">git</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">work_tree</span><span class="o">=</span><span class="n">pkg_dir</span><span class="p">)</span>
        <span class="n">clog</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">log_func</span><span class="o">=</span><span class="nb">print</span><span class="p">)</span>

    <span class="n">ggit</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">answer_yes_to_all_prompts</span><span class="p">:</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Should I do a &#39;git add *&#39;? ([Y]/n): &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">answer</span> <span class="ow">and</span> <span class="n">answer</span> <span class="o">!=</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Okay, I&#39;ll stop here.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="n">ggit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;add </span><span class="si">{</span><span class="n">what_to_add</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">ggit</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span>  <span class="c1"># show status again</span>

    <span class="n">commit_command</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;commit -m &quot;</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">commit_message</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">answer_yes_to_all_prompts</span><span class="p">:</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Should I </span><span class="si">{</span><span class="n">commit_command</span><span class="si">}</span><span class="s2"> and push? ([Y]/n)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">answer</span> <span class="ow">and</span> <span class="n">answer</span> <span class="o">!=</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Okay, I&#39;ll stop here.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="n">ggit</span><span class="p">(</span><span class="n">commit_command</span><span class="p">)</span>
    <span class="n">ggit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;push&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">generate_and_publish_docs</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">publish_docs_to</span><span class="o">=</span><span class="s2">&quot;github&quot;</span><span class="p">):</span>
    <span class="c1"># TODO: Figure out epythet and wads relationship -- right now, there&#39;s a reflexive dependency</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">epythet</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_autodocs</span><span class="p">,</span> <span class="n">make</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="s2">&quot;Documentation operations require epythet. &quot;</span>
            <span class="s2">&quot;Install wads with documentation support: pip install wads[docs]&quot;</span>
        <span class="p">)</span>

    <span class="n">warn</span><span class="p">(</span>
        <span class="s2">&quot;generate_and_publish_docs is deprecated and requires epythet. &quot;</span>
        <span class="s2">&quot;Install wads with documentation support: pip install wads[docs]&quot;</span><span class="p">,</span>
        <span class="ne">DeprecationWarning</span><span class="p">,</span>
        <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">make_autodocs</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">publish_docs_to</span><span class="p">:</span>
        <span class="n">make</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">publish_docs_to</span><span class="p">)</span>


<span class="n">PathStr</span> <span class="o">=</span> <span class="nb">str</span>
<span class="n">PkgName</span> <span class="o">=</span> <span class="nb">str</span>
<span class="n">PkgSpec</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">PathStr</span><span class="p">,</span> <span class="n">ModuleType</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span> <span class="n">PkgName</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">delete_pkg_directories</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">:</span> <span class="n">PathStr</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">shutil</span><span class="w"> </span><span class="kn">import</span> <span class="n">rmtree</span>

    <span class="n">pkg_dir</span><span class="p">,</span> <span class="n">pkg_dirname</span> <span class="o">=</span> <span class="n">extract_pkg_dir_and_name</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
    <span class="n">names_to_delete</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dist&quot;</span><span class="p">,</span> <span class="s2">&quot;build&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg_dirname</span><span class="si">}</span><span class="s2">.egg-info&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">name_to_delete</span> <span class="ow">in</span> <span class="n">names_to_delete</span><span class="p">:</span>
        <span class="n">delete_dirpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">name_to_delete</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">delete_dirpath</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting folder: </span><span class="si">{</span><span class="n">delete_dirpath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">rmtree</span><span class="p">(</span><span class="n">delete_dirpath</span><span class="p">)</span>


<div class="viewcode-block" id="get_module_path">
<a class="viewcode-back" href="../../module_docs/wads/pack.html#wads.pack.get_module_path">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_module_path</span><span class="p">(</span><span class="n">module</span><span class="p">:</span> <span class="n">ModuleType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the path to the directory containing the module&#39;s code file.</span>

<span class="sd">    &gt;&gt;&gt; import os</span>
<span class="sd">    &gt;&gt;&gt; get_module_path(os)  # doctest: +SKIP</span>
<span class="sd">    &#39;/usr/lib/python3.8&#39;</span>
<span class="sd">    &gt;&gt;&gt; import sklearn  # doctest: +SKIP</span>
<span class="sd">    &gt;&gt;&gt; get_module_path(sklearn)  # doctest: +SKIP</span>
<span class="sd">    &#39;/usr/local/lib/python3.8/dist-packages/sklearn&#39;</span>
<span class="sd">    &gt;&gt;&gt; import local_package  # doctest: +SKIP</span>
<span class="sd">    &gt;&gt;&gt; get_module_path(local_package)  # doctest: +SKIP</span>
<span class="sd">    &#39;/home/user/projects/local_package/local_package&#39;</span>

<span class="sd">    Read more: https://github.com/i2mint/wads/discussions/7#discussioncomment-9761632</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">ModuleType</span><span class="p">):</span>
        <span class="n">loader</span> <span class="o">=</span> <span class="n">pkgutil</span><span class="o">.</span><span class="n">get_loader</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loader</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_filename</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find the filename for module </span><span class="si">{</span><span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">get_filename</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">module</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_get_pkg_dir_and_name</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">pkg_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pkg_dir</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">):</span>
        <span class="n">pkg_dir</span> <span class="o">=</span> <span class="n">pkg_dir</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pkg_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Directory </span><span class="si">{</span><span class="n">pkg_dir</span><span class="si">}</span><span class="s2"> wasn&#39;t found&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pkg_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">):</span>
            <span class="n">name_candidates</span> <span class="o">=</span> <span class="n">folders_that_have_init_py_files</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name_candidates</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;pkg_dir=</span><span class="si">{</span><span class="n">pkg_dir</span><span class="si">}</span><span class="s2"> doesn&#39;t itself contain a dir named </span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_candidates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;pkg_dir=</span><span class="si">{</span><span class="n">pkg_dir</span><span class="si">}</span><span class="s2"> contains multiple dirs with __init__.py files: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name_candidates</span><span class="si">}</span><span class="s2">, so I don&#39;t know which to chose as the package name&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pkg_name</span> <span class="o">=</span> <span class="n">name_candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pkg_dir</span><span class="p">,</span> <span class="n">pkg_name</span>


<div class="viewcode-block" id="extract_pkg_dir_and_name">
<a class="viewcode-back" href="../../module_docs/wads/pack.html#wads.pack.extract_pkg_dir_and_name">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_pkg_dir_and_name</span><span class="p">(</span>
    <span class="n">pkg_spec</span><span class="p">:</span> <span class="n">PkgSpec</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">validate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts the pkg_dir and pkg_dirname from the input `pkg_spec`.</span>
<span class="sd">    Optionally validates the pkg_dir is actually one (has a pkg_name/__init__.py file)</span>

<span class="sd">    Also processes input to get a path from a pathlib.Path object, or a module object,</span>
<span class="sd">    or a module/package name string.</span>

<span class="sd">    `pkg_spec` can be an imported package (must be a locally developped package)</span>
<span class="sd">    whose name and containing directory is the same):</span>

<span class="sd">    &gt;&gt;&gt; import wads</span>
<span class="sd">    &gt;&gt;&gt; extract_pkg_dir_and_name(wads)  # doctest: +ELLIPSIS</span>
<span class="sd">    (.../wads&#39;, &#39;wads&#39;)</span>

<span class="sd">    You can also just specify the name of the package (it will be imported):</span>

<span class="sd">    &gt;&gt;&gt; extract_pkg_dir_and_name(&#39;wads&#39;)  # doctest: +SKIP</span>
<span class="sd">    (&#39;.../wads&#39;, &#39;wads&#39;)</span>

<span class="sd">    Or you can specify the path to the package directory explicitly:</span>

<span class="sd">    &gt;&gt;&gt; extract_pkg_dir_and_name(&#39;/home/user/projects/wads&#39;)  # doctest: +SKIP</span>
<span class="sd">    (&#39;/home/user/projects/wads&#39;, &#39;wads&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pkg_spec</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">):</span>
        <span class="n">pkg_spec</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pkg_spec</span><span class="p">)</span>
    <span class="c1"># if pkg_spec has only alphanumeric characters, assume it&#39;s a package name and import it</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pkg_spec</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">pkg_spec</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pkg_spec</span><span class="o">.</span><span class="n">isalnum</span><span class="p">():</span>
        <span class="n">pkg_spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">pkg_spec</span><span class="p">)</span>
    <span class="c1"># if pkg_spec is a module object, get the path to the module</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pkg_spec</span><span class="p">,</span> <span class="n">ModuleType</span><span class="p">):</span>
        <span class="n">module_dir</span> <span class="o">=</span> <span class="n">get_module_path</span><span class="p">(</span><span class="n">pkg_spec</span><span class="p">)</span>
        <span class="c1"># package dir is the parent of module dir</span>
        <span class="c1"># Note that this is only true for packages developped locally</span>
        <span class="n">pkg_spec</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">module_dir</span><span class="p">)</span>

    <span class="n">pkg_dir</span><span class="p">,</span> <span class="n">pkg_name</span> <span class="o">=</span> <span class="n">_get_pkg_dir_and_name</span><span class="p">(</span><span class="n">pkg_spec</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Directory </span><span class="si">{</span><span class="n">pkg_dir</span><span class="si">}</span><span class="s2"> wasn&#39;t found&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;pkg_dir=</span><span class="si">{</span><span class="n">pkg_dir</span><span class="si">}</span><span class="s2"> doesn&#39;t itself contain a dir named </span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">assert</span> <span class="s2">&quot;__init__.py&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">pkg_name</span><span class="p">)),</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;pkg_dir=</span><span class="si">{</span><span class="n">pkg_dir</span><span class="si">}</span><span class="s2"> contains a dir named </span><span class="si">{</span><span class="n">pkg_name</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;but that dir isn&#39;t a package (does not have a __init__.py&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">pkg_dir</span><span class="p">,</span> <span class="n">pkg_name</span></div>



<div class="viewcode-block" id="folders_that_have_init_py_files">
<a class="viewcode-back" href="../../module_docs/wads/pack.html#wads.pack.folders_that_have_init_py_files">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">folders_that_have_init_py_files</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">:</span> <span class="n">PathStr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a list of folders in the package directory that have an __init__.py file.</span>

<span class="sd">    &gt;&gt;&gt; folders_that_have_init_py_files(&#39;/home/user/projects/wads&#39;)  # doctest: +SKIP</span>
<span class="sd">    [&#39;wads&#39;, &#39;wads/util&#39;, &#39;wads/pack&#39;, &#39;wads/docs_gen&#39;]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">d</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
        <span class="ow">and</span> <span class="s2">&quot;__init__.py&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
    <span class="p">]</span></div>



<div class="viewcode-block" id="get_pkg_name">
<a class="viewcode-back" href="../../module_docs/wads/pack.html#wads.pack.get_pkg_name">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_pkg_name</span><span class="p">(</span><span class="n">pkg_spec</span><span class="p">:</span> <span class="n">PkgSpec</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PkgName</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the name of the package from a package name, module object or path.</span>
<span class="sd">    Optionally validates some naming rules.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pkg_dir</span><span class="p">,</span> <span class="n">pkg_dirname</span> <span class="o">=</span> <span class="n">extract_pkg_dir_and_name</span><span class="p">(</span><span class="n">pkg_spec</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">)</span>
    <span class="n">configs_pkg_name</span> <span class="o">=</span> <span class="n">get_name_from_configs</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">pkg_dirname</span> <span class="o">==</span> <span class="n">configs_pkg_name</span><span class="p">,</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">pkg_dirname</span><span class="si">=}</span><span class="s2"> and </span><span class="si">{</span><span class="n">configs_pkg_name</span><span class="si">=}</span><span class="s2"> were not the same&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">configs_pkg_name</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_get_pkg_dir</span><span class="p">(</span><span class="n">pkg_spec</span><span class="p">:</span> <span class="n">PkgSpec</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PathStr</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the path to the package directory from a package name, module object or path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pkg_dir</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">extract_pkg_dir_and_name</span><span class="p">(</span><span class="n">pkg_spec</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pkg_dir</span>


<span class="k">def</span><span class="w"> </span><span class="nf">current_configs</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">):</span>
    <span class="n">configs</span> <span class="o">=</span> <span class="n">read_configs</span><span class="p">(</span><span class="n">pkg_dir</span><span class="o">=</span><span class="n">_get_pkg_dir</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">))</span>
    <span class="n">pprint</span><span class="p">(</span><span class="n">configs</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">current_configs_version</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">):</span>
    <span class="n">pkg_dir</span> <span class="o">=</span> <span class="n">_get_pkg_dir</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>

    <span class="c1"># Prefer pyproject.toml if it exists</span>
    <span class="k">if</span> <span class="n">_has_pyproject_toml</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_project_version</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">read_configs</span><span class="p">(</span><span class="n">pkg_dir</span><span class="o">=</span><span class="n">pkg_dir</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">)</span>


<span class="c1"># TODO: Both setup and twine are python. Change to use python objects directly.</span>
<div class="viewcode-block" id="update_setup_cfg">
<a class="viewcode-back" href="../../module_docs/wads/pack.html#wads.pack.update_setup_cfg">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">update_setup_cfg</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">new_deploy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update setup.cfg or pyproject.toml.</span>
<span class="sd">    If version is not given, will ask pypi (via http request) what the current version</span>
<span class="sd">    is, and increment that.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pkg_dir</span> <span class="o">=</span> <span class="n">_get_pkg_dir</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
    <span class="n">configs</span> <span class="o">=</span> <span class="n">read_and_resolve_setup_configs</span><span class="p">(</span>
        <span class="n">pkg_dir</span><span class="o">=</span><span class="n">_get_pkg_dir</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">),</span>
        <span class="n">new_deploy</span><span class="o">=</span><span class="n">new_deploy</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">pprint</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{configs}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">clog</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="n">pprint</span><span class="p">(</span><span class="n">configs</span><span class="p">))</span>

    <span class="c1"># Write to pyproject.toml if it exists, otherwise setup.cfg</span>
    <span class="k">if</span> <span class="n">_has_pyproject_toml</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">):</span>
        <span class="c1"># Update pyproject.toml with the resolved configs</span>
        <span class="n">pyproject_data</span> <span class="o">=</span> <span class="n">read_pyproject_toml</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;project&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pyproject_data</span><span class="p">:</span>
            <span class="n">pyproject_data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Map key fields back to pyproject.toml format</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">pyproject_data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;version&quot;</span> <span class="ow">in</span> <span class="n">configs</span><span class="p">:</span>
            <span class="n">project</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">configs</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;description&quot;</span> <span class="ow">in</span> <span class="n">configs</span><span class="p">:</span>
            <span class="n">project</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">configs</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">configs</span><span class="p">:</span>
            <span class="n">project</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">configs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;url&quot;</span> <span class="ow">in</span> <span class="n">configs</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;urls&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">project</span><span class="p">:</span>
                <span class="n">project</span><span class="p">[</span><span class="s2">&quot;urls&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">project</span><span class="p">[</span><span class="s2">&quot;urls&quot;</span><span class="p">][</span><span class="s2">&quot;Homepage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">configs</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>

        <span class="n">write_pyproject_toml</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">pyproject_data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">write_configs</span><span class="p">(</span><span class="n">pkg_dir</span><span class="o">=</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">configs</span><span class="o">=</span><span class="n">configs</span><span class="p">)</span></div>



<div class="viewcode-block" id="set_version">
<a class="viewcode-back" href="../../module_docs/wads/pack.html#wads.pack.set_version">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">set_version</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update version in config file (pyproject.toml and/or setup.cfg)&quot;&quot;&quot;</span>
    <span class="n">pkg_dir</span> <span class="o">=</span> <span class="n">_get_pkg_dir</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="s2">&quot;version should be a string&quot;</span>

    <span class="c1"># Update both files if both exist to keep them in sync</span>
    <span class="n">has_pyproject</span> <span class="o">=</span> <span class="n">_has_pyproject_toml</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
    <span class="n">has_setup_cfg</span> <span class="o">=</span> <span class="n">_has_setup_cfg</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">has_pyproject</span><span class="p">:</span>
        <span class="n">set_project_version</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">has_setup_cfg</span><span class="p">:</span>
        <span class="n">configs</span> <span class="o">=</span> <span class="n">read_configs</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
        <span class="n">configs</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">version</span>
        <span class="n">write_configs</span><span class="p">(</span><span class="n">pkg_dir</span><span class="o">=</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">configs</span><span class="o">=</span><span class="n">configs</span><span class="p">)</span></div>



<div class="viewcode-block" id="increment_configs_version">
<a class="viewcode-back" href="../../module_docs/wads/pack.html#wads.pack.increment_configs_version">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">increment_configs_version</span><span class="p">(</span>
    <span class="n">pkg_dir</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Increment version in config file (pyproject.toml and/or setup.cfg).&quot;&quot;&quot;</span>
    <span class="n">pkg_dir</span> <span class="o">=</span> <span class="n">_get_pkg_dir</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>

    <span class="c1"># Check which config files exist</span>
    <span class="n">has_pyproject</span> <span class="o">=</span> <span class="n">_has_pyproject_toml</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
    <span class="n">has_setup_cfg</span> <span class="o">=</span> <span class="n">_has_setup_cfg</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>

    <span class="c1"># Determine the version to use</span>
    <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">has_pyproject</span><span class="p">:</span>
            <span class="c1"># Get current version from pyproject.toml</span>
            <span class="n">current_version</span> <span class="o">=</span> <span class="n">get_project_version</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">increment_version</span><span class="p">(</span><span class="n">current_version</span><span class="p">)</span> <span class="k">if</span> <span class="n">current_version</span> <span class="k">else</span> <span class="s2">&quot;0.0.1&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get version from setup.cfg</span>
            <span class="n">configs</span> <span class="o">=</span> <span class="n">read_configs</span><span class="p">(</span><span class="n">pkg_dir</span><span class="o">=</span><span class="n">pkg_dir</span><span class="p">)</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">_get_version</span><span class="p">(</span>
                <span class="n">pkg_dir</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span> <span class="n">configs</span><span class="o">=</span><span class="n">configs</span><span class="p">,</span> <span class="n">new_deploy</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">increment_version</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>

    <span class="c1"># Update both files if both exist to keep them in sync</span>
    <span class="k">if</span> <span class="n">has_pyproject</span><span class="p">:</span>
        <span class="n">set_project_version</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">has_setup_cfg</span><span class="p">:</span>
        <span class="n">configs</span> <span class="o">=</span> <span class="n">read_configs</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
        <span class="n">configs</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">version</span>
        <span class="n">write_configs</span><span class="p">(</span><span class="n">pkg_dir</span><span class="o">=</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">configs</span><span class="o">=</span><span class="n">configs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">version</span></div>



<div class="viewcode-block" id="run_setup">
<a class="viewcode-back" href="../../module_docs/wads/pack.html#wads.pack.run_setup">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">run_setup</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run ``python -m build`` (modern PEP 517 compliant build)&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------------------- build_output ---------------------------&quot;</span><span class="p">)</span>
    <span class="n">pkg_dir</span> <span class="o">=</span> <span class="n">_get_pkg_dir</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
    <span class="n">original_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>

    <span class="c1"># Use python -m build (PEP 517 standard)</span>
    <span class="c1"># Falls back to legacy setup.py if build module not available</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">build_output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;build&quot;</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">build_output</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Build stderr: </span><span class="si">{</span><span class="n">build_output</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">build_output</span><span class="o">.</span><span class="n">check_returncode</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">build_output</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Fallback to legacy method if build module not installed</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: &#39;build&#39; module not found, falling back to setup.py&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Consider installing: pip install build&quot;</span><span class="p">)</span>
        <span class="n">build_output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="si">}</span><span class="s2"> setup.py sdist bdist_wheel&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">original_dir</span><span class="p">)</span></div>



<div class="viewcode-block" id="twine_upload_dist">
<a class="viewcode-back" href="../../module_docs/wads/pack.html#wads.pack.twine_upload_dist">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">twine_upload_dist</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">options_str</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Publish to pypi. Runs ``python -m twine upload dist/*``&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------------------- upload_output ---------------------------&quot;</span><span class="p">)</span>
    <span class="n">pkg_dir</span> <span class="o">=</span> <span class="n">_get_pkg_dir</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
    <span class="n">original_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
    <span class="c1"># TODO: dist/*? How to publish just last one?</span>
    <span class="k">if</span> <span class="n">options_str</span><span class="p">:</span>
        <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="si">}</span><span class="s2"> -m twine upload </span><span class="si">{</span><span class="n">options_str</span><span class="si">}</span><span class="s2"> dist/*&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="si">}</span><span class="s2"> -m twine upload dist/*&quot;</span>
    <span class="c1"># print(command)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">original_dir</span><span class="p">)</span></div>

    <span class="c1"># print(f&quot;{upload_output.decode()}\n&quot;)</span>


<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># setup.cfg reading and writing</span>

<span class="c1"># TODO: A lot of work done here to read setup.cfg. setup function apparently does it for you. How to use that?</span>


<span class="c1"># TODO: postprocess_ini_section_items and preprocess_ini_section_items: Add comma separated possibility?</span>
<span class="c1"># TODO: Find out if configparse has an option to do this processing alreadys</span>
<div class="viewcode-block" id="postprocess_ini_section_items">
<a class="viewcode-back" href="../../module_docs/wads/pack.html#wads.pack.postprocess_ini_section_items">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">postprocess_ini_section_items</span><span class="p">(</span><span class="n">items</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Transform newline-separated string values into actual list of strings (assuming that intent)</span>

<span class="sd">    &gt;&gt;&gt; section_from_ini = {</span>
<span class="sd">    ...     &#39;name&#39;: &#39;wads&#39;,</span>
<span class="sd">    ...     &#39;keywords&#39;: &#39;\n\tpackaging\n\tpublishing&#39;</span>
<span class="sd">    ... }</span>
<span class="sd">    &gt;&gt;&gt; section_for_python = dict(postprocess_ini_section_items(section_from_ini))</span>
<span class="sd">    &gt;&gt;&gt; section_for_python</span>
<span class="sd">    {&#39;name&#39;: &#39;wads&#39;, &#39;keywords&#39;: [&#39;packaging&#39;, &#39;publishing&#39;]}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">splitter_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;[</span><span class="se">\n\r\t</span><span class="s2">]+&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">splitter_re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">vv</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span> <span class="k">if</span> <span class="n">vv</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
            <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">vv</span> <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">vv</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)]</span>  <span class="c1"># remove commented lines</span>
        <span class="k">yield</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span></div>



<span class="c1"># TODO: Find out if configparse has an option to do this processing already</span>
<div class="viewcode-block" id="preprocess_ini_section_items">
<a class="viewcode-back" href="../../module_docs/wads/pack.html#wads.pack.preprocess_ini_section_items">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">preprocess_ini_section_items</span><span class="p">(</span><span class="n">items</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transform list values into newline-separated strings, in view of writing the value to a ini formatted section</span>

<span class="sd">    &gt;&gt;&gt; section = {</span>
<span class="sd">    ...     &#39;name&#39;: &#39;wads&#39;,</span>
<span class="sd">    ...     &#39;keywords&#39;: [&#39;documentation&#39;, &#39;packaging&#39;, &#39;publishing&#39;]</span>
<span class="sd">    ... }</span>
<span class="sd">    &gt;&gt;&gt; for_ini = dict(preprocess_ini_section_items(section))</span>
<span class="sd">    &gt;&gt;&gt; print(&#39;keywords =&#39; + for_ini[&#39;keywords&#39;])  # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">    keywords =</span>
<span class="sd">        documentation</span>
<span class="sd">        packaging</span>
<span class="sd">        publishing</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;,&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="k">yield</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">read_configs</span><span class="p">(</span>
    <span class="n">pkg_dir</span><span class="p">:</span> <span class="n">PathStr</span><span class="p">,</span>
    <span class="n">postproc</span><span class="o">=</span><span class="n">postprocess_ini_section_items</span><span class="p">,</span>
    <span class="n">section</span><span class="o">=</span><span class="n">METADATA_SECTION</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">PathStr</span><span class="p">),</span> <span class="p">(</span>
        <span class="s2">&quot;It doesn&#39;t look like pkg_dir is a path. Did you perhaps invert pkg_dir and postproc order&quot;</span>
    <span class="p">)</span>
    <span class="n">pkg_dir</span> <span class="o">=</span> <span class="n">_get_pkg_dir</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>

    <span class="c1"># Try pyproject.toml first (modern approach)</span>
    <span class="n">pyproject_filepath</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">PYPROJECT_FILE_NAME</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pyproject_filepath</span><span class="p">):</span>
        <span class="n">pyproject_data</span> <span class="o">=</span> <span class="n">read_pyproject_toml</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
        <span class="n">project_metadata</span> <span class="o">=</span> <span class="n">pyproject_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># Convert pyproject.toml format to setup.cfg format for compatibility</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">project_metadata</span><span class="p">:</span>
            <span class="c1"># Map common fields</span>
            <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">project_metadata</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">project_metadata</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;version&quot;</span> <span class="ow">in</span> <span class="n">project_metadata</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">project_metadata</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;description&quot;</span> <span class="ow">in</span> <span class="n">project_metadata</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">project_metadata</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;urls&quot;</span> <span class="ow">in</span> <span class="n">project_metadata</span><span class="p">:</span>
                <span class="n">urls</span> <span class="o">=</span> <span class="n">project_metadata</span><span class="p">[</span><span class="s2">&quot;urls&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">urls</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="c1"># Try to get a root_url or homepage</span>
                    <span class="k">if</span> <span class="s2">&quot;Homepage&quot;</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
                        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">urls</span><span class="p">[</span><span class="s2">&quot;Homepage&quot;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="s2">&quot;repository&quot;</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
                        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">urls</span><span class="p">[</span><span class="s2">&quot;repository&quot;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="s2">&quot;Repository&quot;</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
                        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">urls</span><span class="p">[</span><span class="s2">&quot;Repository&quot;</span><span class="p">]</span>
            <span class="c1"># Handle authors</span>
            <span class="k">if</span> <span class="s2">&quot;authors&quot;</span> <span class="ow">in</span> <span class="n">project_metadata</span><span class="p">:</span>
                <span class="n">authors</span> <span class="o">=</span> <span class="n">project_metadata</span><span class="p">[</span><span class="s2">&quot;authors&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">authors</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">authors</span><span class="p">:</span>
                    <span class="c1"># Join author names</span>
                    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">authors</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;license&quot;</span> <span class="ow">in</span> <span class="n">project_metadata</span><span class="p">:</span>
                <span class="n">license_info</span> <span class="o">=</span> <span class="n">project_metadata</span><span class="p">[</span><span class="s2">&quot;license&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">license_info</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;license&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">license_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;license&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">license_info</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;keywords&quot;</span> <span class="ow">in</span> <span class="n">project_metadata</span><span class="p">:</span>
                <span class="n">keywords</span> <span class="o">=</span> <span class="n">project_metadata</span><span class="p">[</span><span class="s2">&quot;keywords&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keywords</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;keywords&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">keywords</span>
            <span class="k">if</span> <span class="s2">&quot;dependencies&quot;</span> <span class="ow">in</span> <span class="n">project_metadata</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="s2">&quot;install_requires&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">project_metadata</span><span class="p">[</span><span class="s2">&quot;dependencies&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Read configs from pyproject.toml: </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="c1"># Fall back to setup.cfg (legacy approach)</span>
    <span class="n">config_filepath</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">CONFIG_FILE_NAME</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">config_filepath</span><span class="p">):</span>
        <span class="n">c</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">config_filepath</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">section</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">section</span><span class="p">)</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">section</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">postproc</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">postproc</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">return</span> <span class="n">d</span>


<span class="k">def</span><span class="w"> </span><span class="nf">write_configs</span><span class="p">(</span>
    <span class="n">pkg_dir</span><span class="p">:</span> <span class="n">PathStr</span><span class="p">,</span>
    <span class="n">configs</span><span class="p">,</span>
    <span class="n">preproc</span><span class="o">=</span><span class="n">preprocess_ini_section_items</span><span class="p">,</span>
    <span class="n">dflt_options</span><span class="o">=</span><span class="n">DFLT_OPTIONS</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">PathStr</span><span class="p">),</span> <span class="p">(</span>
        <span class="s2">&quot;It doesn&#39;t look like pkg_dir is a path. Did you perhaps invert pkg_dir and configs order&quot;</span>
    <span class="p">)</span>
    <span class="n">pkg_dir</span> <span class="o">=</span> <span class="n">_get_pkg_dir</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
    <span class="n">config_filepath</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">CONFIG_FILE_NAME</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">config_filepath</span><span class="p">):</span>
        <span class="n">c</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">config_filepath</span><span class="p">))</span>

    <span class="n">metadata_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">preproc</span><span class="p">(</span><span class="n">configs</span><span class="p">))</span>

    <span class="c1"># Filter out None values and convert non-strings to strings for ConfigParser</span>
    <span class="n">metadata_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metadata_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>

    <span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dflt_options</span><span class="p">,</span> <span class="o">**</span><span class="n">read_configs</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">preproc</span><span class="p">,</span> <span class="n">OPTIONS_SECTION</span><span class="p">))</span>

    <span class="c1"># TODO: Legacy. Reorg key to [section][key] mapping to avoid such ugly complexities.</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s2">&quot;install_requires&quot;</span><span class="p">,</span>
        <span class="s2">&quot;install-requires&quot;</span><span class="p">,</span>
        <span class="s2">&quot;packages&quot;</span><span class="p">,</span>
        <span class="s2">&quot;zip_safe&quot;</span><span class="p">,</span>
        <span class="s2">&quot;include_package_data&quot;</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">metadata_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
                <span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
                    <span class="n">k</span>
                <span class="p">)</span>  <span class="c1"># get it out of metadata_dict and into options</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">metadata_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
                    <span class="n">k</span>
                <span class="p">)</span>  <span class="c1"># if it&#39;s both in metadata and in options, just get it out of metadata</span>

    <span class="c1"># Handle nested sections like extras_require</span>
    <span class="c1"># Extract any keys that look like extras_require_* from both metadata and options</span>
    <span class="n">extras_require</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Check metadata_dict first</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metadata_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;extras_require_&quot;</span><span class="p">):</span>
            <span class="n">extra_name</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;extras_require_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">extras_require</span><span class="p">[</span><span class="n">extra_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">metadata_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="c1"># Check options dict too (since extras_require_testing might end up there via DFLT_OPTIONS)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;extras_require_&quot;</span><span class="p">):</span>
            <span class="n">extra_name</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;extras_require_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">extras_require</span><span class="p">[</span><span class="n">extra_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="n">c</span><span class="p">[</span><span class="n">METADATA_SECTION</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata_dict</span>
    <span class="n">c</span><span class="p">[</span><span class="n">OPTIONS_SECTION</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span>

    <span class="c1"># Add extras_require section if we have any</span>
    <span class="k">if</span> <span class="n">extras_require</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;options.extras_require&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">c</span><span class="p">[</span><span class="s2">&quot;options.extras_require&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">extra_name</span><span class="p">,</span> <span class="n">packages</span> <span class="ow">in</span> <span class="n">extras_require</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Preprocess the packages (convert list to newline format if needed)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">packages</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">packages</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">packages</span><span class="p">)</span>
            <span class="n">c</span><span class="p">[</span><span class="s2">&quot;options.extras_require&quot;</span><span class="p">][</span><span class="n">extra_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">packages</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_filepath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>


<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># Versioning</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">packaging.version</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse</span>


<div class="viewcode-block" id="sorted_versions">
<a class="viewcode-back" href="../../module_docs/wads/pack.html#wads.pack.sorted_versions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">sorted_versions</span><span class="p">(</span><span class="n">strings</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">version_patch_prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter out and return version strings in (versioning) descending order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">version_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;^(\d+.)</span><span class="se">{{</span><span class="s2">2</span><span class="se">}}</span><span class="si">{</span><span class="n">version_patch_prefix</span><span class="si">}</span><span class="s2">\d+$&quot;</span><span class="p">)</span>

    <span class="c1"># Filter and sort the versions in descending order</span>
    <span class="n">sorted_versions</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">version_patch_prefix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">strings</span>
            <span class="k">if</span> <span class="n">version_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">key</span><span class="o">=</span><span class="n">parse</span><span class="p">,</span>
        <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">sorted_versions</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">increment_version</span><span class="p">(</span><span class="n">version_str</span><span class="p">):</span>
    <span class="n">version_nums</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">version_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)))</span>
    <span class="n">version_nums</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">version_nums</span><span class="p">))</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

    <span class="n">requests_is_installed</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
    <span class="n">requests_is_installed</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="http_get_json">
<a class="viewcode-back" href="../../module_docs/wads/pack.html#wads.pack.http_get_json">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">http_get_json</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">use_requests</span><span class="o">=</span><span class="n">requests_is_installed</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make ah http request to url and get json, and return as python dict&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">use_requests</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;response code was </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">urllib.request</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">urllib.error</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPError</span>

        <span class="n">req</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;response code was </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">HTTPError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># to indicate (hopefully) that name doesn&#39;t exist</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span></div>



<span class="n">PYPI_PACKAGE_JSON_URL</span> <span class="o">=</span> <span class="s2">&quot;https://pypi.python.org/pypi/</span><span class="si">{package}</span><span class="s2">/json&quot;</span>


<span class="c1"># TODO: Perhaps there&#39;s a safer way to analyze errors (and determine if the package exists or other HTTPError)</span>
<div class="viewcode-block" id="versions_from_pypi">
<a class="viewcode-back" href="../../module_docs/wads/pack.html#wads.pack.versions_from_pypi">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">versions_from_pypi</span><span class="p">(</span>
    <span class="n">pkg_dir</span><span class="p">:</span> <span class="n">PathStr</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_requests</span><span class="o">=</span><span class="n">requests_is_installed</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return version of package on pypi.python.org using json.</span>

<span class="sd">    :param package: Name of the package</span>
<span class="sd">    :return: A version (string) or None if there was an exception (usually means there</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">get_pkg_name</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">PYPI_PACKAGE_JSON_URL</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">package</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">pkg_info</span> <span class="o">=</span> <span class="n">http_get_json</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">use_requests</span><span class="o">=</span><span class="n">use_requests</span><span class="p">)</span>
        <span class="n">releases</span> <span class="o">=</span> <span class="n">pkg_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;releases&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got an exception trying to get the versions from pypi: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># keep only the versions that don&#39;t have yanked=True</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">yanked_release</span><span class="p">(</span><span class="n">release_info_list</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;yanked&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">release_info_list</span><span class="p">)</span>

    <span class="n">releases</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">releases</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">yanked_release</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">sorted_versions</span><span class="p">(</span><span class="n">releases</span><span class="p">)</span></div>



<div class="viewcode-block" id="highest_pypi_version">
<a class="viewcode-back" href="../../module_docs/wads/pack.html#wads.pack.highest_pypi_version">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">highest_pypi_version</span><span class="p">(</span>
    <span class="n">pkg_dir</span><span class="p">:</span> <span class="n">PathStr</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_requests</span><span class="o">=</span><span class="n">requests_is_installed</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return version of package on pypi.python.org using json.</span>

<span class="sd">    &gt;&gt;&gt; highest_pypi_version(&#39;wads&#39;)  # doctest: +SKIP</span>
<span class="sd">    &#39;0.1.19&#39;</span>

<span class="sd">    :param package: Name of the package</span>
<span class="sd">    :return: A version (string) or None if there was an exception (usually means there</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">versions</span> <span class="o">=</span> <span class="n">versions_from_pypi</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">use_requests</span><span class="o">=</span><span class="n">use_requests</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">versions</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">versions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

    <span class="c1"># else: return None</span>


<div class="viewcode-block" id="current_pypi_version">
<a class="viewcode-back" href="../../module_docs/wads/pack.html#wads.pack.current_pypi_version">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">current_pypi_version</span><span class="p">(</span>
    <span class="n">pkg_dir</span><span class="p">:</span> <span class="n">PathStr</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return version of package on pypi.python.org using json.</span>

<span class="sd">    &gt;&gt;&gt; current_pypi_version(&#39;wads&#39;)  # doctest: +SKIP</span>
<span class="sd">    &#39;0.1.19&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">get_pkg_name</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">PYPI_PACKAGE_JSON_URL</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">package</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">][</span><span class="s2">&quot;version&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># raise Exception(f&quot;Failed to get information for package {name=}, {pkg_dir=}&quot;)</span>
        <span class="k">return</span> <span class="kc">None</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">next_version_for_package</span><span class="p">(</span>
    <span class="n">pkg_dir</span><span class="p">:</span> <span class="n">PathStr</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">version_if_current_version_none</span><span class="o">=</span><span class="s2">&quot;0.0.1&quot;</span><span class="p">,</span>
    <span class="n">use_requests</span><span class="o">=</span><span class="n">requests_is_installed</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">get_name_from_configs</span><span class="p">(</span><span class="n">pkg_dir</span><span class="o">=</span><span class="n">pkg_dir</span><span class="p">)</span>
    <span class="n">current_version</span> <span class="o">=</span> <span class="n">current_pypi_version</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">use_requests</span><span class="o">=</span><span class="n">use_requests</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">current_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">increment_version</span><span class="p">(</span><span class="n">current_version</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">version_if_current_version_none</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_version</span><span class="p">(</span>
    <span class="n">pkg_dir</span><span class="p">:</span> <span class="n">PathStr</span><span class="p">,</span>
    <span class="n">version</span><span class="p">,</span>
    <span class="n">configs</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">new_deploy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">version</span> <span class="ow">or</span> <span class="n">configs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">new_deploy</span><span class="p">:</span>
                <span class="n">version</span> <span class="o">=</span> <span class="n">next_version_for_package</span><span class="p">(</span>
                    <span class="n">pkg_dir</span><span class="p">,</span> <span class="n">name</span>
                <span class="p">)</span>  <span class="c1"># when you want to make a new package</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">version</span> <span class="o">=</span> <span class="n">current_pypi_version</span><span class="p">(</span>
                    <span class="n">pkg_dir</span><span class="p">,</span> <span class="n">name</span>
                <span class="p">)</span>  <span class="c1"># when you want to make a new package</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Got an error trying to get the new version of </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> so will try to get the version from setup.cfg...&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">configs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Couldn&#39;t fetch the next version from PyPi (no API token?), &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;nor did I find a version in setup.cfg (metadata section).&quot;</span>
                <span class="p">)</span>
    <span class="k">return</span> <span class="n">version</span>


<span class="k">def</span><span class="w"> </span><span class="nf">versions_from_tags</span><span class="p">(</span><span class="n">pkg_spec</span><span class="p">:</span> <span class="n">PkgSpec</span><span class="p">,</span> <span class="n">version_patch_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="n">pkg_dir</span><span class="p">,</span> <span class="n">pkg_name</span> <span class="o">=</span> <span class="n">extract_pkg_dir_and_name</span><span class="p">(</span><span class="n">pkg_spec</span><span class="p">)</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">git</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">,</span> <span class="n">work_tree</span><span class="o">=</span><span class="n">pkg_dir</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)]</span>
    <span class="c1"># Pattern to match versions with the patch prefix</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="sa">rf</span><span class="s2">&quot;^(\d+.)</span><span class="se">{{</span><span class="s2">2</span><span class="se">}}</span><span class="si">{</span><span class="n">version_patch_prefix</span><span class="si">}</span><span class="s2">\d+$&quot;</span>
    <span class="c1"># Filter and sort the versions in descending order</span>
    <span class="n">sorted_versions</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">version_patch_prefix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tags</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="p">],</span>
        <span class="n">key</span><span class="o">=</span><span class="n">parse</span><span class="p">,</span>
        <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">sorted_versions</span>


<span class="k">def</span><span class="w"> </span><span class="nf">highest_tag_version</span><span class="p">(</span><span class="n">pkg_spec</span><span class="p">:</span> <span class="n">PkgSpec</span><span class="p">,</span> <span class="n">version_patch_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="n">sorted_tag_versions</span> <span class="o">=</span> <span class="n">versions_from_tags</span><span class="p">(</span><span class="n">pkg_spec</span><span class="p">,</span> <span class="n">version_patch_prefix</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_tag_versions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sorted_tag_versions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="kc">None</span>


<div class="viewcode-block" id="setup_cfg_version">
<a class="viewcode-back" href="../../module_docs/wads/pack.html#wads.pack.setup_cfg_version">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">setup_cfg_version</span><span class="p">(</span><span class="n">pkg_spec</span><span class="p">:</span> <span class="n">PkgSpec</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get version from setup.cfg file.&quot;&quot;&quot;</span>
    <span class="n">pkg_dir</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">extract_pkg_dir_and_name</span><span class="p">(</span><span class="n">pkg_spec</span><span class="p">)</span>
    <span class="n">configs</span> <span class="o">=</span> <span class="n">read_configs</span><span class="p">(</span><span class="n">pkg_dir</span><span class="o">=</span><span class="n">pkg_dir</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">configs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>



<div class="viewcode-block" id="pyproject_toml_version">
<a class="viewcode-back" href="../../module_docs/wads/pack.html#wads.pack.pyproject_toml_version">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pyproject_toml_version</span><span class="p">(</span><span class="n">pkg_spec</span><span class="p">:</span> <span class="n">PkgSpec</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get version from pyproject.toml file.&quot;&quot;&quot;</span>
    <span class="n">pkg_dir</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">extract_pkg_dir_and_name</span><span class="p">(</span><span class="n">pkg_spec</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">get_project_version</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">versions_from_different_sources</span><span class="p">(</span><span class="n">pkg_spec</span><span class="p">:</span> <span class="n">PkgSpec</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;tag&quot;</span><span class="p">:</span> <span class="n">highest_tag_version</span><span class="p">(</span><span class="n">pkg_spec</span><span class="p">),</span>
        <span class="s2">&quot;current_pypi&quot;</span><span class="p">:</span> <span class="n">current_pypi_version</span><span class="p">(</span><span class="n">pkg_spec</span><span class="p">),</span>
        <span class="s2">&quot;highest_not_yanked_pypi&quot;</span><span class="p">:</span> <span class="n">highest_pypi_version</span><span class="p">(</span><span class="n">pkg_spec</span><span class="p">),</span>
        <span class="s2">&quot;setup_cfg&quot;</span><span class="p">:</span> <span class="n">setup_cfg_version</span><span class="p">(</span><span class="n">pkg_spec</span><span class="p">),</span>
        <span class="s2">&quot;pyproject_toml&quot;</span><span class="p">:</span> <span class="n">pyproject_toml_version</span><span class="p">(</span><span class="n">pkg_spec</span><span class="p">),</span>
    <span class="p">}</span>


<span class="n">ValidVersionSources</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span>
    <span class="s2">&quot;tag&quot;</span><span class="p">,</span> <span class="s2">&quot;current_pypi&quot;</span><span class="p">,</span> <span class="s2">&quot;highest_not_yanked_pypi&quot;</span><span class="p">,</span> <span class="s2">&quot;setup_cfg&quot;</span><span class="p">,</span> <span class="s2">&quot;pyproject_toml&quot;</span>
<span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">raise_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">error_type</span><span class="o">=</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">error_type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<div class="viewcode-block" id="validate_versions">
<a class="viewcode-back" href="../../module_docs/wads/pack.html#wads.pack.validate_versions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_versions</span><span class="p">(</span><span class="n">versions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">action_when_not_valid</span><span class="o">=</span><span class="n">raise_error</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate versions from different sources.</span>

<span class="sd">    You get the versions input from the `versions_from_different_sources` function.</span>

<span class="sd">    :param versions: A dictionary with the versions from different sources</span>
<span class="sd">    :param action_when_not_valid: A function that will be called when the versions are not valid</span>
<span class="sd">        Default is to raise a ValueError with the error message.</span>
<span class="sd">        Another option is to print the error message, log it, or issue a warning.</span>
<span class="sd">    :return: The versions if they are valid</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: Raise specific exceptions with what-to-do-about-it messages</span>
    <span class="c1">#   Tip: Write the instructions in a github wiki/discussion/issue and provide link</span>

    <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">tag_version</span> <span class="o">=</span> <span class="n">versions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tag_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tag_version</span> <span class="o">!=</span> <span class="n">versions</span><span class="p">[</span><span class="s2">&quot;setup_cfg&quot;</span><span class="p">]:</span>
        <span class="n">error_msg</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Tag version (</span><span class="si">{</span><span class="n">tag_version</span><span class="si">}</span><span class="s2">) is different &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;from setup.cfg&#39;s version: </span><span class="si">{</span><span class="n">versions</span><span class="p">[</span><span class="s1">&#39;setup_cfg&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">versions</span><span class="p">[</span><span class="s2">&quot;current_pypi&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">versions</span><span class="p">[</span><span class="s2">&quot;highest_not_yanked_pypi&quot;</span><span class="p">]:</span>
        <span class="n">error_msg</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Current pypi version (</span><span class="si">{</span><span class="n">versions</span><span class="p">[</span><span class="s1">&#39;current_pypi&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) is different &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;from the highest not yanked pypi version: </span><span class="si">{</span><span class="n">versions</span><span class="p">[</span><span class="s1">&#39;highest_not_yanked_pypi&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">versions</span><span class="p">[</span><span class="s2">&quot;current_pypi&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">versions</span><span class="p">[</span><span class="s2">&quot;setup_cfg&quot;</span><span class="p">]:</span>
        <span class="n">error_msg</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Current pypi version (</span><span class="si">{</span><span class="n">versions</span><span class="p">[</span><span class="s1">&#39;current_pypi&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) is higher &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;than setup.cfg&#39;s version: </span><span class="si">{</span><span class="n">versions</span><span class="p">[</span><span class="s1">&#39;setup_cfg&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">error_msg</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Please make sure the versions are consistent and then try again: </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">versions</span><span class="si">=}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">action_when_not_valid</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

    <span class="c1"># but if all is well, return the versions:</span>
    <span class="k">return</span> <span class="n">versions</span></div>



<span class="c1"># -----------------------------------------------------------------------------</span>


<div class="viewcode-block" id="read_and_resolve_setup_configs">
<a class="viewcode-back" href="../../module_docs/wads/pack.html#wads.pack.read_and_resolve_setup_configs">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_and_resolve_setup_configs</span><span class="p">(</span>
    <span class="n">pkg_dir</span><span class="p">:</span> <span class="n">PathStr</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">new_deploy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">assert_names</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;make setup params and call setup</span>

<span class="sd">    :param pkg_dir: Directory where the pkg is (which is also where the setup.cfg is)</span>
<span class="sd">    :param new_deploy: whether this setup for a new deployment (publishing to pypi) or not</span>
<span class="sd">    :param version: The version number to set this up as.</span>
<span class="sd">                    If not given will look at setup.cfg[metadata] for one,</span>
<span class="sd">                    and if not found there will use the current version (requesting pypi.org)</span>
<span class="sd">                    and bump it if the new_deploy flag is on</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># read the config file (get a dict with it&#39;s contents)</span>
    <span class="n">pkg_dir</span><span class="p">,</span> <span class="n">pkg_dirname</span> <span class="o">=</span> <span class="n">_get_pkg_dir_and_name</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">assert_names</span><span class="p">:</span>
        <span class="n">extract_pkg_dir_and_name</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>

    <span class="n">configs</span> <span class="o">=</span> <span class="n">read_configs</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>

    <span class="c1"># parse out name and root_url</span>
    <span class="c1"># If URL is missing, try to infer it from git</span>
    <span class="k">if</span> <span class="s2">&quot;root_url&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">configs</span> <span class="ow">and</span> <span class="s2">&quot;url&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">configs</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">wads.populate</span><span class="w"> </span><span class="kn">import</span> <span class="n">_get_pkg_url_from_pkg_dir</span>

            <span class="n">git_url</span> <span class="o">=</span> <span class="n">_get_pkg_url_from_pkg_dir</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>
            <span class="n">configs</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">git_url</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No url or root_url found in configs. Inferred from git: </span><span class="si">{</span><span class="n">git_url</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Consider adding it to your pyproject.toml or setup.cfg.&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;configs didn&#39;t have a root_url or url, and couldn&#39;t infer from git. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Please add a url field to your pyproject.toml [project.urls] section &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;or setup.cfg [metadata] section. Git error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">configs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pkg_dirname</span>
    <span class="k">if</span> <span class="n">assert_names</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">name</span> <span class="o">==</span> <span class="n">pkg_dirname</span><span class="p">,</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;config name (</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">) and pkg_dirname (</span><span class="si">{</span><span class="n">pkg_dirname</span><span class="si">}</span><span class="s2">) are not equal!&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;root_url&quot;</span> <span class="ow">in</span> <span class="n">configs</span><span class="p">:</span>
        <span class="n">root_url</span> <span class="o">=</span> <span class="n">configs</span><span class="p">[</span><span class="s2">&quot;root_url&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">root_url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span>
            <span class="s2">&quot;/&quot;</span>
        <span class="p">):</span>  <span class="c1"># yes, it&#39;s a url so it&#39;s always forward slash, not the systems&#39; slash os.sep</span>
            <span class="n">root_url</span> <span class="o">=</span> <span class="n">root_url</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_url</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;url&quot;</span> <span class="ow">in</span> <span class="n">configs</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">configs</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;configs didn&#39;t have a root_url or url. It should have at least one of these!&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Note: if version is not in config, version will be None,</span>
    <span class="c1">#  resulting in bumping the version or making it be 0.0.1 if the package is not found (i.e. first deploy)</span>

    <span class="n">meta_data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">configs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="c1"># make the setup_kwargs</span>
    <span class="n">setup_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">meta_data_dict</span><span class="p">,</span>
        <span class="c1"># You can add more key=val pairs here if they&#39;re missing in config file</span>
    <span class="p">)</span>

    <span class="n">version</span> <span class="o">=</span> <span class="n">_get_version</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">configs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">new_deploy</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">text_of_readme_md_file</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;README.md&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># Get packages list - use what&#39;s in configs, or discover from directory structure</span>
    <span class="n">packages_list</span> <span class="o">=</span> <span class="n">configs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;packages&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">packages_list</span><span class="p">:</span>
        <span class="c1"># For modern pyproject.toml, packages are in [tool.hatch.build.targets.wheel]</span>
        <span class="c1"># For legacy setup.cfg, fall back to simple discovery</span>
        <span class="n">packages_list</span> <span class="o">=</span> <span class="n">folders_that_have_init_py_files</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>

    <span class="n">dflt_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
        <span class="n">packages</span><span class="o">=</span><span class="n">packages_list</span><span class="p">,</span>
        <span class="n">include_package_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">platforms</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">,</span>
        <span class="c1"># long_description=text_of_readme_md_file(),</span>
        <span class="c1"># long_description_content_type=&quot;text/markdown&quot;,</span>
        <span class="n">description_file</span><span class="o">=</span><span class="s2">&quot;README.md&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">configs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dflt_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">setup_kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">configs</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_print_some_lines_of_code</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">file_contents</span><span class="p">,</span> <span class="n">slice_</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;------------ lines </span><span class="si">{</span><span class="n">slice_</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2"> through </span><span class="si">{</span><span class="n">slice_</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> ------------&quot;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_contents</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="n">slice_</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------------------&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_slice_from_string</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">string</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)))</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ask_user_what_to_do_about_this_file</span><span class="p">(</span>
    <span class="n">file</span><span class="p">,</span> <span class="n">file_contents</span><span class="p">,</span> <span class="n">dflt_n_lines_slice</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">start_here</span><span class="o">=</span><span class="mi">0</span>
<span class="p">):</span>
    <span class="n">ask_again</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">_ask_user_what_to_do_about_this_file</span><span class="p">(</span>
        <span class="n">file</span><span class="p">,</span> <span class="n">file_contents</span><span class="p">,</span> <span class="n">dflt_n_lines_slice</span><span class="p">,</span> <span class="n">start_here</span>
    <span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Enter a one liner doc for </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> then press enter:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">start_here</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">start_here</span> <span class="o">+</span> <span class="n">dflt_n_lines_slice</span>
        <span class="n">print_these_lines</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
        <span class="n">start_here</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="n">dflt_n_lines_slice</span>  <span class="c1"># so that next time r == &#39;&#39;, we print new lines</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">print_these_lines</span> <span class="o">=</span> <span class="n">_slice_from_string</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">print_these_lines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_print_some_lines_of_code</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">file_contents</span><span class="p">,</span> <span class="n">print_these_lines</span><span class="p">)</span>
        <span class="c1"># ... and then call the function again, recursively, until exit or some doc string is given</span>
        <span class="k">return</span> <span class="n">ask_again</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_equals_or_first_letter_of</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;exit&quot;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exiting...&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;exit&quot;</span>
        <span class="k">if</span> <span class="n">_equals_or_first_letter_of</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;skip&quot;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping that one...&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;skip&quot;</span>
        <span class="k">if</span> <span class="n">_equals_or_first_letter_of</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;funcs&quot;</span><span class="p">):</span>
            <span class="n">_print_functions_and_classes</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">file_contents</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ask_again</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---&gt; Your docstring needs to be at least 5 characters&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ask_again</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">r</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_print_functions_and_classes</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">file_contents</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gen</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file_contents</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="n">stripped_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">stripped_line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;def &quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">stripped_line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;class &quot;</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">line</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;----------- funcs, classes, and methods of </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> -----------&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gen</span><span class="p">()))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------------------&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_equals_or_first_letter_of</span><span class="p">(</span><span class="n">input_string</span><span class="p">,</span> <span class="n">target_string</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">input_string</span> <span class="o">==</span> <span class="n">target_string</span> <span class="ow">or</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">input_string</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">input_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">target_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>


<div class="viewcode-block" id="process_missing_module_docstrings">
<a class="viewcode-back" href="../../module_docs/wads/pack.html#wads.pack.process_missing_module_docstrings">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_missing_module_docstrings</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">pkg_dir</span><span class="p">:</span> <span class="n">PathStr</span><span class="p">,</span>
    <span class="n">action</span><span class="o">=</span><span class="s2">&quot;input&quot;</span><span class="p">,</span>
    <span class="n">exceptions</span><span class="o">=</span><span class="p">(),</span>
    <span class="n">docstr_template</span><span class="o">=</span><span class="s1">&#39;&quot;&quot;&quot;</span><span class="se">\n</span><span class="si">{user_input}</span><span class="se">\n</span><span class="s1">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Goes through modules of package, sees which ones don&#39;t have docstrings,</span>
<span class="sd">    and gives you the option to write one.</span>

<span class="sd">    The function will go through all .py files (except those mentioned in exceptions),</span>
<span class="sd">    check if there&#39;s a module docstring (that is, that the first non-white characters are</span>
<span class="sd">    triple-quotes (double or single)).</span>

<span class="sd">    What happens with that depends on the ``action`` argument,</span>

<span class="sd">    If ``action=&#39;list&#39;``, those modules missing docstrings will be listed.</span>
<span class="sd">    If ``action=&#39;count&#39;``, the count of those modules missing docstrings will be returned.</span>

<span class="sd">    If ``action=&#39;input&#39;``, for every module you&#39;ll be given the option to enter a</span>
<span class="sd">    SINGLE LINE module docstring (though you could include multi-lines with \n).</span>
<span class="sd">    Just type the docstring you want and hit enter to go to the next module with missing docstring.</span>
<span class="sd">    Or, you can also:</span>
<span class="sd">        - type exit, or e: To exit this process</span>
<span class="sd">        - type skip, or s: To skip the module and go to the next</span>
<span class="sd">        - type funcs, or f: To see a print out of functions, classes, and methods</span>
<span class="sd">        - just hit enter, to get some lines of code (the first, then the next, etc.)</span>
<span class="sd">        - enter a number, or a number:number, to specify what lines you want to see printed</span>
<span class="sd">    Printing lines helps you write an informed module docstring</span>

<span class="sd">    :keyword module, docstr, docstrings, module doc strings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">dol</span><span class="w"> </span><span class="kn">import</span> <span class="n">TextFiles</span><span class="p">,</span> <span class="n">filt_iter</span>

    <span class="n">pkg_dir</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_get_pkg_dir_and_name</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">)</span>

    <span class="n">exceptions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">exceptions</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">filt_iter</span><span class="p">(</span>
        <span class="n">TextFiles</span><span class="p">(</span><span class="n">pkg_dir</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.py&quot;</span><span class="p">,</span> <span class="n">max_levels</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
        <span class="n">filt</span><span class="o">=</span><span class="n">exceptions</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">files_and_contents_that_dont_have_docs</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">file</span><span class="p">,</span> <span class="n">file_contents</span> <span class="ow">in</span> <span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">file_contents</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">contents</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&quot;&quot;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">contents</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&#39;&#39;&quot;</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">file</span><span class="p">,</span> <span class="n">file_contents</span>

    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;list&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">file</span> <span class="k">for</span> <span class="n">file</span><span class="p">,</span> <span class="n">file_contents</span> <span class="ow">in</span> <span class="n">files_and_contents_that_dont_have_docs</span><span class="p">()</span>
        <span class="p">]</span>
    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">files_and_contents_that_dont_have_docs</span><span class="p">()))</span>
    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;input&quot;</span><span class="p">:</span>
        <span class="n">were_no_files</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">file</span><span class="p">,</span> <span class="n">file_contents</span> <span class="ow">in</span> <span class="n">files_and_contents_that_dont_have_docs</span><span class="p">():</span>
            <span class="n">were_no_files</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">_ask_user_what_to_do_about_this_file</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">file_contents</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="s2">&quot;exit&quot;</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="n">r</span> <span class="o">==</span> <span class="s2">&quot;skip&quot;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">files</span><span class="p">[</span><span class="n">file</span><span class="p">]</span> <span class="o">=</span> <span class="n">docstr_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_input</span><span class="o">=</span><span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="n">file_contents</span>

        <span class="k">if</span> <span class="n">were_no_files</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---&gt; Seems like all your modules have docstrings! Congrads!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown action: </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<span class="c1"># -----------------------------------------------------------------------------</span>


<span class="n">argh_kwargs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;pack&quot;</span><span class="p">,</span>
    <span class="s2">&quot;functions&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">generate_and_publish_docs</span><span class="p">,</span>
        <span class="n">current_configs</span><span class="p">,</span>
        <span class="n">increment_configs_version</span><span class="p">,</span>
        <span class="n">current_configs_version</span><span class="p">,</span>
        <span class="n">twine_upload_dist</span><span class="p">,</span>
        <span class="n">read_and_resolve_setup_configs</span><span class="p">,</span>
        <span class="n">update_setup_cfg</span><span class="p">,</span>
        <span class="n">go</span><span class="p">,</span>
        <span class="n">goo</span><span class="p">,</span>
        <span class="n">check_in</span><span class="p">,</span>
        <span class="n">get_name_from_configs</span><span class="p">,</span>
        <span class="n">run_setup</span><span class="p">,</span>
        <span class="n">current_pypi_version</span><span class="p">,</span>
        <span class="n">extract_pkg_dir_and_name</span><span class="p">,</span>
        <span class="n">git_commit_and_push</span><span class="p">,</span>
        <span class="n">process_missing_module_docstrings</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s2">&quot;namespace_kwargs&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Package Configurations&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Utils to package and publish.&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">argh</span>  <span class="c1"># pip install argh</span>

    <span class="n">argh</span><span class="o">.</span><span class="n">dispatch_commands</span><span class="p">(</span><span class="n">argh_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;functions&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright NO COPYRIGHT.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>